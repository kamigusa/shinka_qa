# Banking System Example - Shinka Quality デモンストレーション

この例では、現実的な**エンタープライズ銀行システム**モジュールにおけるShinka Qualityの機能を実証します。ミッションクリティカルな金融ソフトウェアにおいて、自動テスト進化がテストカバレッジとバグ検出を劇的に向上させる様子を示します。

## 概要

**モジュール**: `account_manager.py` - 銀行口座管理システム
**複雑度**: 129ステートメント、46分岐
**ドメイン**: 金融サービス（規制産業）
**初期状態**: ハッピーパステストのみのレガシーテストスイート（58%カバレッジ）

## この例が示すもの

### 1. 現実的なエンタープライズシナリオ

- **複雑なビジネスロジック**: 最低残高要件、日次引出限度額、送金手数料
- **複数のエラー条件**: InsufficientBalanceError、AccountFrozenError、InvalidAmountError
- **状態管理**: 口座ステータス（ACTIVE、FROZEN、CLOSED）
- **監査要件**: フィルタリング機能付き取引履歴
- **財務計算**: バリデーション付き利息計算

### 2. 進化の結果

| 指標 | 改善前 | 改善後 | 改善度 |
|--------|--------|-------|-------------|
| **テストケース数** | 5 | 35 | +600% |
| **分岐カバレッジ** | 58% | 95% | +37ポイント |
| **バグ検出率** | 22% (2/9) | 100% (9/9) | +78ポイント |
| **適応度スコア** | 0.456 | 0.924 | +103% |

### 3. 経済的インパクト

- **節約時間**: 22.5時間（テスト作成時間90%削減）
- **コスト削減**: ¥180,000のエンジニアリングコスト
- **バグ防止価値**: ¥3,500,000（7つの重大バグを防止）
- **総ROI**: ¥3,680,000

## この例に含まれるファイル

```
banking_system/
├── account_manager.py                      # 本番コード（正常版）
├── account_manager_buggy.py                # バグ混入版（意図的に9個のバグ）
├── test_account_manager_initial.py         # レガシーテストスイート（5テスト、58%カバレッジ）
├── test_account_manager_evolved_gen1.py    # 第1世代（10テスト、63%カバレッジ）
├── test_account_manager_evolved_gen2.py    # 第2世代（20テスト、79%カバレッジ）
├── test_account_manager_evolved_final.py   # 最終世代（35テスト、95%カバレッジ）
├── quality_config.yaml                     # Shinka Quality設定
├── evolution_results.json                  # 詳細なメトリクスと進行状況
├── EVOLUTION_REPORT.md                     # 詳細なテキストレポート
├── evolution_report.html                   # グラフ付きインタラクティブHTMLレポート
└── CASE_STUDY.md                           # 経営層向けケーススタディ

```

## クイックスタート

### 1. 初期テストの実行（ベースライン）

```bash
cd examples/banking_system

# テストを実行してカバレッジを測定
pytest test_account_manager_initial.py -v --cov=account_manager --cov-report=term-missing --cov-branch

# 期待結果: 5件成功、58%分岐カバレッジ
```

### 2. 進化後テストの実行（最終版）

```bash
# 進化したテストスイートを実行
pytest test_account_manager_evolved_final.py -v --cov=account_manager --cov-report=term-missing --cov-branch

# 期待結果: 35件成功、95%分岐カバレッジ
```

### 3. バグ検出のテスト（初期版 vs 進化版）

```bash
# 元のファイルをバックアップ
cp account_manager.py account_manager_backup.py

# バグ版に置き換え
cp account_manager_buggy.py account_manager.py

# 初期テストスイートでテスト（2/9個のバグを検出）
pytest test_account_manager_initial.py -v

# 進化版テストスイートでテスト（9/9個のバグを検出）
pytest test_account_manager_evolved_final.py -v

# 元に戻す
mv account_manager_backup.py account_manager.py
```

### 4. 進化レポートの表示

ブラウザで `evolution_report.html` を開くと、以下が表示されます：
- カバレッジとバグ検出の進行を示すインタラクティブグラフ
- 世代ごとの詳細
- ROI分析
- エンタープライズベネフィットのサマリー

## account_manager_buggy.py の意図的なバグ

バグ混入版には、金融システムでよく見られる9つの現実的なバグが含まれています：

1. **バグ #1**: 口座番号バリデーションが緩すぎる（11桁以上を許可）
   - 場所: `__init__`, 80行目
   - 種類: 入力バリデーション

2. **バグ #2**: 最低残高チェックが不正（< の代わりに <=）
   - 場所: `__init__`, 87行目
   - 種類: ビジネスロジック

3. **バグ #3**: ゼロ額の入金が許可される
   - 場所: `deposit`, 104行目
   - 種類: 入力バリデーション

4. **バグ #4**: 大規模取引制限が高すぎる（1億ではなく100億）
   - 場所: `deposit`, 108行目
   - 種類: ビジネスルール

5. **バグ #5**: 最低残高チェックが反転（< の代わりに >）
   - 場所: `withdraw`, 135行目
   - 種類: ロジックエラー（重大）

6. **バグ #6**: 日次引出限度額チェックが欠落
   - 場所: `withdraw`, 141-144行目（コメントアウト）
   - 種類: ビジネスルール違反

7. **バグ #7**: 凍結された受取口座のチェックが欠落
   - 場所: `transfer`, 174-175行目（コメントアウト）
   - 種類: ビジネスルール違反

8. **バグ #8**: 送金手数料が合計額に含まれていない
   - 場所: `transfer`, 181行目
   - 種類: 財務計算エラー

9. **バグ #9**: マイナス金利のバリデーションが欠落
   - 場所: `calculate_interest`, 268-269行目（コメントアウト）
   - 種類: 入力バリデーション

## 設定

`quality_config.yaml` はエンタープライズ向けの設定を使用しています：

```yaml
fitness_weights:
  coverage: 0.35          # テストカバレッジ
  bug_detection: 0.45     # バグ検出（金融システムでは最優先）
  efficiency: 0.10        # 実行効率
  maintainability: 0.10   # コード品質
```

**理由**: 金融システムでは正確性がスピードより優先されるため、バグ検出の重みが最も高く（45%）設定されています。

## 進化戦略

この例では3つの変異戦略を使用しています：

1. **add_edge_cases**: 境界値テストを追加（0、負数、最大値）
2. **improve_assertions**: より良いバリデーションのためにアサーションを強化
3. **add_parametrize**: 複数シナリオ向けのパラメータ化テストを作成

## エンタープライズにおける関連性

### 規制コンプライアンス

- **SOX（サーベンス・オクスリー法）**: 95%カバレッジは効果的な内部統制を実証
- **Basel III**: 包括的テストによりオペレーショナルリスクを削減
- **FISC安全対策基準**: 日本の金融システムセキュリティ要件を満たす

### リスク軽減

- **本番環境でのゼロバグ**: 100%バグ検出により金融エラーを防止
- **監査証跡**: 取引履歴テストにより規制コンプライアンスを確保
- **安全なリファクタリング**: 包括的テストにより自信を持ってコード改善を実施

### コスト効率

- **手動テスト**: 25時間 @ ¥8,000/時間 = ¥200,000
- **Shinka Quality**: 2.5時間 = ¥20,000
- **節約額**: モジュールあたり¥180,000

50以上のモジュールを持つ典型的な銀行システムの場合：
- **総節約額**: ¥9,000,000以上
- **バグ防止**: ¥175,000,000以上（350バグ @ ¥500,000/バグ）
- **ROI**: 920倍

## 次のステップ

### 評価用

1. **CASE_STUDY.mdを確認**: ビジネスケース付き経営層向け概要
2. **evolution_report.htmlを開く**: 結果のビジュアルプレゼンテーション
3. **自分でテストを実行**: 自身の環境で結果を検証
4. **自分のコードでテスト**: 自身のモジュールにShinka Qualityを適用

### 本番環境での使用

1. **CI/CDとの統合**: パイプラインにShinka Qualityを追加
2. **定期的な進化の設定**: 週次でテスト品質を維持
3. **適応度の重みをカスタマイズ**: 自分のドメインに合わせて優先度を調整
4. **モジュール全体にスケール**: コードベース全体に適用

## FAQ

### Q: これらは現実的なバグですか？

**A**: はい。各バグは本番環境の金融システムで実際に見つかった問題に基づいています：
- バリデーションにおけるオフバイワンエラー
- 反転した比較演算子
- ビジネスルールチェックの欠落
- 手数料の計算エラー
- コメントアウトされたセキュリティチェック

### Q: 進化にはどのくらい時間がかかりますか？

**A**: このモジュールの場合：
- 手動テスト作成: 20-25時間
- Shinka Quality: 2-3時間（自動）
- 時間節約: 90%

### Q: 本番環境で使用できますか？

**A**: この例はデモンストレーション用です。本番環境では：
1. 生成されたテストをレビューして検証
2. ドメイン固有のアサーションを追加
3. テストフレームワークと統合
4. 継続的な進化を設定

### Q: モジュールがもっと複雑な場合は？

**A**: Shinka Qualityは良好にスケールします：
- 100以上のステートメントモジュール: 同様の結果
- 1000以上のステートメントモジュール: より多くの世代が必要な場合あり
- 複数モジュール: 並列進化

## サポート

この例に関する質問や問題については：
- GitHubでissueを開く
- Email: shinka-qa@example.com
- ドキュメント: https://github.com/your-org/shinka-qa

---

**生成ツール**: Shinka Quality v1.0
**ライセンス**: MIT
**ステータス**: 本番環境対応デモンストレーション
